rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- REGLAS DE USUARIOS ---
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.circleId != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.circleId == resource.data.circleId
        )
      );
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- REGLAS DE CÍRCULOS (LECTURA PARA AUTENTICADOS) ---
    match /circles/{circleId} {
      allow read: if request.auth != null;

      allow create: if request.auth != null &&
        request.auth.uid in request.resource.data.members &&
        request.resource.data.members.size() == 1;

      allow delete: if false;

      // Actualizaciones permitidas:
      allow update: if 
        // 1) Unirse a un círculo
        (
          !(request.auth.uid in resource.data.members) &&            // antes no era miembro
          request.auth.uid in request.resource.data.members &&       // ahora sí es miembro
          request.resource.data.members.size() == resource.data.members.size() + 1 &&
          request.resource.data.name == resource.data.name &&
          request.resource.data.invitation_code == resource.data.invitation_code
        )
        ||
        // 2) Actualizar solo tu estado (memberStatus.<uid>)
        (
          request.auth.uid in resource.data.members &&
          request.resource.data.members == resource.data.members &&
          request.resource.data.name == resource.data.name &&
          request.resource.data.invitation_code == resource.data.invitation_code &&
          resource.data.memberStatus.diff(request.resource.data.memberStatus).affectedKeys().hasOnly([request.auth.uid]) &&
          request.resource.data.memberStatus[request.auth.uid].userId == request.auth.uid &&
          // coordinates es opcional; se validan las claves mínimas
          request.resource.data.memberStatus[request.auth.uid].keys().hasAll(['userId', 'statusType', 'timestamp'])
        );
    }

    // --- SUBCOLECCIÓN: HISTORIAL DE ESTADOS ---
    match /circles/{circleId}/statusEvents/{eventId} {
      // Lectura: solo miembros del círculo
      allow read: if request.auth != null &&
        request.auth.uid in get(/databases/$(database)/documents/circles/$(circleId)).data.members;

      // Creación: solo miembros, auto-atribuidos y statusType permitido
      allow create: if request.auth != null &&
        request.auth.uid in get(/databases/$(database)/documents/circles/$(circleId)).data.members &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.statusType in ['fine', 'worried', 'location', 'sos', 'love'];

      // No se permite modificar ni borrar eventos
      allow update, delete: if false;
    }
  }
}