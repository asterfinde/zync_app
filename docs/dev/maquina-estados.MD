# MÃ¡quina de estados (ZYNC) â€” Estado mostrado en CÃ­rculo

## 1. Objetivo

Definir el comportamiento y las transiciones de estado que se muestran en el **CÃ­rculo** para un Usuario, considerando:

- Estados/emoji seleccionados manualmente.
- Estados/emoji provenientes de **Geofencing** (Zonas configuradas).
- Restricciones (no permitir seleccionar Zonas manualmente).
- Indicadores visuales adicionales (`âœ‹ Manual`, `â“ UbicaciÃ³n desconocida`).
- Reglas de **timestamp**.

---

## 2. Glosario

- **Estado (principal)**: el valor que define el **emoji** + **nombre del estado** mostrado en el CÃ­rculo.
  - Ejemplos: `ğŸ“š Estudiando`, `ğŸš¶ En camino`, `ğŸ« Universidad`.
- **Zona**: estado especial asociado a una Zona configurada (Casa/Colegio/Universidad/Trabajo/Personalizada). La Zona se determina por Geofencing.
- **Estado no-zona**: cualquier estado/emoji que no corresponde a una Zona.
- **Indicadores (badges/flags)**: lÃ­neas informativas adicionales debajo del estado.
  - `âœ‹ Manual`
  - `â“ UbicaciÃ³n desconocida`

---

## 3. Vistas del CÃ­rculo (layout lÃ³gico)

Para cualquier estado, el CÃ­rculo puede mostrar:

1. **LÃ­nea 1**: `emoji + nombre del usuario`
2. **LÃ­nea 2**: `texto del estado principal`
3. **LÃ­nea 3**: `timestamp`
4. **LÃ­nea 4 (opcional)**: `âœ‹ Manual`
5. **LÃ­nea 5 (opcional)**: `â“ UbicaciÃ³n desconocida`

Ejemplo:

- `ğŸ“š Mauricio`
- `Estudiando`
- `Hace 15 min`
- `âœ‹ Manual`
- `â“ UbicaciÃ³n desconocida`

---

## 4. ConfiguraciÃ³n base

### 4.1 Sin Zonas configuradas (comportamiento default)

- No existe lÃ³gica de Geofencing para setear estados de Zona.
- El Usuario puede seleccionar cualquier estado/emoji (incluyendo `En camino`).
- El CÃ­rculo muestra siempre:
  - estado principal
  - timestamp
- No aplica restricciÃ³n de â€œzonas manualesâ€ (porque no existen zonas configuradas como tales).

### 4.2 Con Zonas configuradas y Geofencing activo

- Geofencing puede actualizar el estado principal automÃ¡ticamente ante eventos de **entrada/salida**.
- El Usuario puede seleccionar manualmente estados **no-zona** (incluyendo `En camino`).
- El Usuario **NO** puede seleccionar estados de **Zona** manualmente.

---

## 5. Eventos

- **E1: UserSelectNonZone(state)**
  - El Usuario selecciona un estado/emoji que NO corresponde a una Zona.

- **E2: UserSelectZone(zoneState)**
  - El Usuario intenta seleccionar un estado que corresponde a una Zona (Casa/Colegio/Universidad/Trabajo/Personalizada).

- **E3: GeoEnterZone(zoneState)**
  - Geofencing detecta ingreso a una Zona configurada.

- **E4: GeoExitZone**
  - Geofencing detecta salida de una Zona configurada.

- **E5: LocationStatusChanged**
  - Cambia la condiciÃ³n de ubicaciÃ³n (por ejemplo: GPS/permiso falla o se recupera, o se determina que estÃ¡ fuera de zonas).

---

## 6. Estados principales

### 6.1 Estados principales â€œZonaâ€

- `Casa`
- `Colegio`
- `Universidad`
- `Trabajo`
- `Personalizada` (si existe)

> Nota: la app puede representarlos con emoji especÃ­fico por Zona.

### 6.2 Estado principal â€œEn caminoâ€

- Funciona como estado default para **salidas** de cualquier Zona.
- TambiÃ©n puede ser usado manualmente como estado individual.

### 6.3 Otros estados principales (no-zona)

- Cualquier estado/emoji del catÃ¡logo que no sea Zona.

---

## 7. Indicadores (badges/flags)

### 7.1 `âœ‹ Manual`

Se muestra cuando el **Ãºltimo cambio de estado principal** fue realizado manualmente por el Usuario, seleccionando un estado **no-zona**.

- Se activa con `E1: UserSelectNonZone(state)`.
- Se desactiva cuando el estado principal cambia por Geofencing (`E3` o `E4`).

### 7.2 `â“ UbicaciÃ³n desconocida`

Caso borde. Se muestra cuando existe al menos una de estas condiciones:

- El Usuario estÃ¡ **fuera de Zonas configuradas**.
- Hay **fallo de GPS/permiso** (ubicaciÃ³n no disponible / imprecisa).

> RecomendaciÃ³n de implementaciÃ³n: aunque el texto sea uno, modelar internamente dos flags (`outOfZones` y `locationUnavailable`) para no perder precisiÃ³n.

---

## 8. Reglas de transiciÃ³n (mÃ¡quina de estados)

### 8.1 Reglas con Geofencing (si hay Zonas configuradas y Geofencing activo)

#### Regla G1 â€” Entrada a Zona
- Evento: `E3: GeoEnterZone(zoneState)`
- AcciÃ³n:
  - Estado principal := `zoneState`
  - `âœ‹ Manual` := OFF
  - Actualiza timestamp

#### Regla G2 â€” Salida de Zona
- Evento: `E4: GeoExitZone`
- AcciÃ³n:
  - Estado principal := `En camino`
  - `âœ‹ Manual` := OFF
  - Actualiza timestamp

### 8.2 Reglas Manuales

#### Regla M1 â€” Usuario selecciona estado no-zona
- Evento: `E1: UserSelectNonZone(state)`
- AcciÃ³n:
  - Estado principal := `state`
  - `âœ‹ Manual` := ON
  - Actualiza timestamp

#### Regla M2 â€” Usuario intenta seleccionar una Zona (NO permitido)
- Evento: `E2: UserSelectZone(zoneState)`
- AcciÃ³n:
  - Estado principal := sin cambios
  - Mostrar aviso notorio (ver secciÃ³n 9)
  - No actualiza timestamp (no hubo cambio de estado)

> Esta regla aplica para cualquier intento de cambiar una Zona por otra Zona, o seleccionar una Zona desde el selector en general.

### 8.3 Reglas de `â“ UbicaciÃ³n desconocida`

#### Regla U1 â€” Mostrar/ocultar `UbicaciÃ³n desconocida`
- Evento: `E5: LocationStatusChanged`
- AcciÃ³n:
  - Actualizar la visibilidad del indicador `â“ UbicaciÃ³n desconocida` segÃºn condiciones definidas en 7.2.

**Timestamp**:
- Si el indicador aparece o desaparece, **se actualiza timestamp** (se considera cambio visible relevante).

---

## 9. UX del bloqueo (Zonas no seleccionables manualmente)

Cuando el usuario intente seleccionar una Zona manualmente (`E2`):

- Debe mostrarse un **modal evidente**.
- DiseÃ±o sugerido:
  - Fondo (overlay) **gris claro**.
  - Texto **negro** para alto contraste.
  - TÃ­tulo: `AcciÃ³n no permitida`
  - Mensaje: `No puedes seleccionar zonas manualmente. El estado de zonas se actualiza automÃ¡ticamente por geofencing.`
  - BotÃ³n: `Entendido`

Adicional:
- En el selector, las opciones de Zona pueden estar **deshabilitadas** y, al tocarlas, igualmente abrir el modal.

---

## 10. Timestamp

El timestamp es la â€œhuellaâ€ de cualquier actualizaciÃ³n visible del estado mostrado en el CÃ­rculo.

Se actualiza cuando:

- Cambia el **estado principal** (manual o geofence).
- Cambia la visibilidad de un indicador (`âœ‹ Manual`, `â“ UbicaciÃ³n desconocida`).

### 10.1 Formato del timestamp

- `Justo Ahora` -> momento < 59 s (o < 1 min)
- `Hace X min` -> momento < 59 min
- `Hace Y h` -> momento < 24 h
- `Hace Z d` -> si la actualizaciÃ³n es >= 1 dÃ­a

---

## 11. ConsideraciÃ³n mÃ­nima para Zonas solapadas

Para mantener el comportamiento determinista, si mÃºltiples Zonas coinciden al mismo tiempo:

- Gana la Zona de **menor radio** (mÃ¡s especÃ­fica).
- En caso de empate:
  - Gana la Zona creada primero (o la de mayor prioridad si existe ese atributo).

---

## 12. Ejemplos esperados

### 12.1 Default (sin zonas)
- Usuario selecciona `ğŸ“š Estudiando`:
  - Estado: `Estudiando`
  - Timestamp actualizado

### 12.2 Con zonas: entra a Universidad
- Evento `GeoEnterZone(Universidad)`:
  - Estado: `Universidad`
  - `âœ‹ Manual` OFF
  - Timestamp actualizado

### 12.3 Con zonas: usuario cambia a no-zona dentro de Universidad
- Evento `UserSelectNonZone(Estudiando)`:
  - Estado: `Estudiando`
  - `âœ‹ Manual` ON
  - Timestamp actualizado

### 12.4 Con zonas: sale de Universidad
- Evento `GeoExitZone`:
  - Estado: `En camino`
  - `âœ‹ Manual` OFF
  - Timestamp actualizado

### 12.5 Con zonas: intenta seleccionar â€œCasaâ€ manualmente
- Evento `UserSelectZone(Casa)`:
  - Estado no cambia
  - Modal evidente
  - Timestamp no cambia

---

## 13. Checklist de pruebas (manual) â€” ValidaciÃ³n de MÃ¡quina de Estados (CÃ­rculo)

> Objetivo: validar comportamiento de estados/emoji en el CÃ­rculo segÃºn esta mÃ¡quina de estados, incluyendo Geofencing, bloqueo de Zonas manuales, `âœ‹ Manual`, `â“ UbicaciÃ³n desconocida` y formato de timestamp.

### 0) PreparaciÃ³n / Preconditions

- **P0.1**: Tener 2 escenarios disponibles:
  - **Escenario A (SIN Zonas)**: cÃ­rculo sin documentos en `circles/{circleId}/zones/*`.
  - **Escenario B (CON Zonas)**: cÃ­rculo con al menos 1 documento en `circles/{circleId}/zones/*`.
- **P0.2**: Usuario autenticado y dentro del cÃ­rculo.
- **P0.3 (para Geofencing)**:
  - Permisos de ubicaciÃ³n concedidos.
  - UbicaciÃ³n del dispositivo activa.
  - (Opcional) UbicaciÃ³n simulada si se usa emulador.

---

## 1) Escenario A â€” SIN Zonas configuradas (comportamiento default)

### Prueba A1 â€” SelecciÃ³n manual de cualquier estado (incluye `home/school/work/university` si existen en catÃ¡logo)

- **Pasos**
  - Abrir el CÃ­rculo.
  - Tocar tu usuario para abrir el selector de estado.
  - Seleccionar varios estados (ej. `ğŸ“š studying`, `ğŸš— driving`, y tambiÃ©n `ğŸ  home`, `ğŸ« school`, `ğŸ’¼ work`, `ğŸ“ university` si aparecen).
- **Esperado**
  - **NO** aparece modal de bloqueo.
  - El estado cambia y se refleja en el CÃ­rculo.
  - **NO** se muestra `âœ‹ Manual` (no se estÃ¡ sobre-escribiendo geofencing; no existen Zonas configuradas).
  - El timestamp se actualiza y usa el formato definido (ver secciÃ³n 5).

### Prueba A2 â€” â€œEn caminoâ€ manual

- **Pasos**
  - En el selector, elegir `ğŸš— En camino` (`driving`).
- **Esperado**
  - Estado principal: `ğŸš—` + `En camino`.
  - **NO** `âœ‹ Manual`.
  - Timestamp actualizado.

---

## 2) Escenario B â€” CON Zonas configuradas + Geofencing activo

### Prueba B1 â€” Bloqueo de selecciÃ³n manual de Zonas (regla 3.3)

- **Pasos**
  - Abrir el selector de estado.
  - Intentar seleccionar `ğŸ  home`, `ğŸ« school`, `ğŸ’¼ work`, `ğŸ“ university`.
- **Esperado**
  - El estado principal **NO** cambia.
  - Aparece un **modal notorio**:
    - Fondo/overlay gris claro
    - Texto negro
    - TÃ­tulo `AcciÃ³n no permitida`
    - Mensaje de â€œNo puedes seleccionar zonas manualmenteâ€¦â€
    - BotÃ³n `Entendido`
  - Timestamp **NO** cambia (no hubo cambio de estado).

### Prueba B2 â€” SelecciÃ³n manual de un estado NO-Zona

- **Pasos**
  - Abrir el selector.
  - Elegir un estado NO-Zona (ej. `ğŸ“š Estudiando`, `ğŸ”´ Ocupado`, etc.).
- **Esperado**
  - El estado cambia y se refleja en el CÃ­rculo.
  - **NO** se muestra `âœ‹ Manual` (porque `âœ‹ Manual` es exclusivo para sobre-escritura de estados automÃ¡ticos de Zona).
  - Timestamp actualizado.

### Prueba B3 â€” â€œEn caminoâ€ manual (permitido)

- **Pasos**
  - Abrir el selector.
  - Elegir `ğŸš— En camino` manualmente.
- **Esperado**
  - Estado: `ğŸš— En camino`.
  - **NO** `âœ‹ Manual`.
  - Timestamp actualizado.

---

## 3) Geofencing â€” Entrada a Zona (G1)

### Prueba G1 â€” Auto update al entrar a Zona configurada

- **Pasos**
  - En Escenario B, ubicarse fuera de una zona configurada.
  - Entrar fÃ­sicamente (o simular) dentro del radio de una zona.
  - Esperar a que el evento se refleje.
- **Esperado**
  - El estado cambia automÃ¡ticamente a la Zona:
    - Emoji: el emoji de zona (ej. `ğŸ /ğŸ«/ğŸ“/ğŸ’¼` o `ğŸ“` si es custom)
    - Texto: nombre de zona (`zoneName`)
  - **NO** `âœ‹ Manual`.
  - Timestamp actualizado.

---

## 4) Geofencing â€” Salida de Zona (G2)

### Prueba G2 â€” Auto â€œEn caminoâ€ al salir de cualquier Zona

- **Pasos**
  - Estar dentro de una zona configurada (estado debe reflejar esa zona).
  - Salir fÃ­sicamente (o simular) fuera del radio.
- **Esperado**
  - Estado cambia automÃ¡ticamente a `ğŸš— En camino`.
  - **NO** `âœ‹ Manual`.
  - Timestamp actualizado.

---

## 5) Casos excepcionales (Manual override de un estado automÃ¡tico)

> Regla clave: `âœ‹ Manual` **solo aparece** cuando el usuario **sobre-escribe** un estado **automÃ¡tico** (geofencing).

### Prueba E1 (caso 3.1) â€” Manual override dentro de la zona (sin salir)

- **Pasos**
  - En Escenario B, entrar a una zona (debe ponerse automÃ¡tico por geofencing).
  - Sin salir de la zona, seleccionar manualmente un estado **NO-Zona** (ej. `ğŸ“š Estudiando`).
- **Esperado**
  - Estado cambia al estado manual seleccionado.
  - Se muestra `âœ‹ Manual`.
  - **NO** debe mostrarse `â“ UbicaciÃ³n desconocida` (porque el usuario no ha salido de la zona).
  - Timestamp actualizado.

### Prueba E2 (caso 3.2) â€” Manual override + salida posterior

- **Pasos**
  - Repetir Prueba E1 hasta quedar en estado manual con `âœ‹ Manual`.
  - Luego salir de la zona configurada (evento de salida).
- **Esperado**
  - El sistema fuerza estado automÃ¡tico `ğŸš— En camino` por salida de zona.
  - `âœ‹ Manual` **se apaga** (porque el estado vuelve a ser automÃ¡tico).
  - Timestamp actualizado.

---

## 6) Timestamp (formato)

### Prueba T1 â€” Formato del timestamp

- **Pasos**
  - Provocar un cambio de estado (manual o automÃ¡tico) y mirar el timestamp.
  - Repetir despuÃ©s de esperar diferentes lapsos.
- **Esperado**
  - `< 60 s`: `Justo Ahora`
  - `< 60 min`: `Hace X min`
  - `< 24 h`: `Hace Y h`
  - `>= 1 dÃ­a`: `Hace Z d`

---

## 7) No-regresiÃ³n (sanity checks)

### Prueba NR1 â€” Estado SOS sigue funcionando

- **Pasos**
  - Seleccionar `ğŸ†˜ SOS`.
- **Esperado**
  - No se rompe el flujo existente.
  - (Si aplica en tu app) conserva el comportamiento de GPS/historial segÃºn lo ya implementado.

### Prueba NR2 â€” Render de miembros (otros usuarios)

- **Pasos**
  - Ver el CÃ­rculo con varios miembros y cambios de estado.
- **Esperado**
  - No hay crashes.
  - Emojis/labels/timestamps se siguen mostrando para todos.
